parameters:
  - name: job
    type: string
  - name: jobResources
    type: string
  - name: serviceConnection
    type: string
  - name: infraPath
    type: string
  - name: parametersPath
    type: string
  - name: rgName
    type: string
  - name: location
    type: string
  - name: overrideParameters
    type: string


jobs:
  - job: "${{ parameters.job }}"
    displayName: "Job: Provision Infrstructure - ${{ parameters.jobResources }}"
    steps:
      - task: AzurePowerShell@5
        inputs:
          azureSubscription: "Visual Studio Professional Subscription(0f7a3b62-c1a4-4aa9-97c3-3bf5f497b5ab)"
          ScriptType: "FilePath"
          ScriptPath: "$(System.DefaultWorkingDirectory)/scripts/create-resource-group.ps1"
          ScriptArguments: '-location westeurope `
            -rgName "${{parameters.rgName}}" `
            -owner "${{parameters.owner}}" `
            -costCenter "${{parameters.costCenter}}" `
            -application "${{parameters.application}}" `
            -description "${{parameters.desc}}" `
            -repo "${{parameters.repo}}"'
          azurePowerShellVersion: "LatestVersion"

      - task: AzureResourceManagerTemplateDeployment@3
        inputs:
          deploymentScope: "Resource Group"
          AzureResourceManagerConnection: "${{parameters.serviceConnection}}"
          action: "Create Or Update Resource Group"
          resourceGroupName: "${{ parameters.rgName }}"
          location: "${{ parameters.location }}"
          templateLocation: "Linked artifact"
          csmParametersFile: "${{ parameters.parametersPath }}/main.bicepparam"
          csmFile: "${{ parameters.infraPath }}/main.bicep"
          deploymentMode: "Incremental"
          overrideParameters: "${{parameters.overrideParameters}}"
