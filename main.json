{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.26.54.24096",
      "templateHash": "6587668203738227727"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the Azure location where the resources should be created."
      }
    },
    "partName": {
      "type": "string",
      "metadata": {
        "description": "the component structure that will be used in name following a convention"
      }
    },
    "version": {
      "type": "int",
      "metadata": {
        "description": "version of deployment"
      }
    },
    "env": {
      "type": "string",
      "allowedValues": [
        "dev",
        "acc",
        "prod"
      ],
      "metadata": {
        "description": "Environment in which the dploy is affected"
      }
    },
    "owner": {
      "type": "string"
    },
    "costCenter": {
      "type": "string"
    },
    "application": {
      "type": "string"
    },
    "descp": {
      "type": "string"
    },
    "repo": {
      "type": "string"
    },
    "databaseName": {
      "type": "string",
      "minLength": 5,
      "maxLength": 20,
      "metadata": {
        "description": "the name of the database"
      }
    },
    "sqlAdminlogin": {
      "type": "securestring",
      "minLength": 5,
      "maxLength": 18,
      "metadata": {
        "description": "the name of the admin to login"
      }
    },
    "keyVaulName": {
      "type": "string",
      "metadata": {
        "description": "name of the keyvault"
      }
    },
    "kvRgName": {
      "type": "string",
      "metadata": {
        "description": "namle of the rg with the keyvault inside"
      }
    },
    "branch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "the branch in the repo where the code is"
      }
    },
    "repoUrl": {
      "type": "string",
      "metadata": {
        "description": "the git repo where the code is"
      }
    },
    "apiConf": {
      "type": "array",
      "metadata": {
        "description": "the domain of the client that will conenct to the api"
      }
    },
    "skuApiServiceCapacity": {
      "type": "int",
      "metadata": {
        "description": "the tier capacity of the app service server holding the api"
      }
    },
    "skuApiServiceName": {
      "type": "string",
      "metadata": {
        "description": "the tiername  of the app service server holding the api"
      }
    },
    "bindingName": {
      "type": "string",
      "metadata": {
        "description": "the binding type required for the function"
      }
    },
    "containerName": {
      "type": "string",
      "metadata": {
        "description": "name of the container linked to the function app"
      }
    }
  },
  "variables": {
    "containerNames": [
      "products",
      "orders",
      "stores"
    ],
    "tag": {
      "owner": "[parameters('owner')]",
      "costCenter": "[parameters('costCenter')]",
      "application": "[parameters('application')]",
      "descp": "[parameters('descp')]",
      "repo": "[parameters('repo')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "managedIdDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "partName": {
            "value": "[parameters('partName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "4211054702363416784"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the Azure location where the resources should be created."
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "managedIdentityName": "[format('uid-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('managedIdentityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "manPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').principalId]"
            },
            "manPrincipalName": {
              "type": "string",
              "value": "[variables('managedIdentityName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storageAccountDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerNames": {
            "value": "[variables('containerNames')]"
          },
          "partName": {
            "value": "[parameters('partName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "13457667836978138875"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the Azure location where the resources should be created."
              }
            },
            "containerNames": {
              "type": "array",
              "defaultValue": [
                "logs",
                "foodelivery-products"
              ],
              "metadata": {
                "description": "the different names of the containers"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "nameSa": "[format('sa{0}', replace(parameters('partName'), '-', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('nameSa')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2"
            },
            {
              "condition": "[not(empty(parameters('containerNames')))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('nameSa'), 'default')]",
              "properties": {
                "isVersioningEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('nameSa'))]"
              ]
            },
            {
              "copy": {
                "name": "blobContainers",
                "count": "[length(parameters('containerNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('nameSa'), 'default', parameters('containerNames')[copyIndex()])]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('nameSa'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageName": {
              "type": "string",
              "value": "[variables('nameSa')]"
            },
            "idStorage": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('nameSa'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyVaultDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "15241449070472884153"
            }
          },
          "parameters": {
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            },
            "keyVaultSku": {
              "type": "object",
              "defaultValue": {
                "name": "standard",
                "family": "A"
              },
              "metadata": {
                "description": "Specifies the SKU to use for the key vault."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the Azure location where the resources should be created."
              }
            }
          },
          "variables": {
            "kvName": "[format('kv{0}', replace(parameters('partName'), '-', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "[variables('kvName')]",
              "location": "[parameters('location')]",
              "properties": {
                "enableRbacAuthorization": true,
                "tenantId": "[tenant().tenantId]",
                "sku": "[parameters('keyVaultSku')]"
              }
            }
          ],
          "outputs": {
            "keyVaultNameOut": {
              "type": "string",
              "value": "[variables('kvName')]"
            },
            "keyVaultIdOut": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('kvName'))]"
            },
            "keyVaultRoleDefinition": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "role-assignment-kv",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "roleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy'), '2022-09-01').outputs.keyVaultRoleDefinition.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "4953152613879033589"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv{0}', replace(parameters('partName'), '-', ''))]",
            "roleAssignmentName": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), parameters('principalId'), parameters('roleDefinitionId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'managedIdDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "role-assignment-sa",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "7109383333365183570"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "the principal id, allows to connect on behalf of the user"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "storageAccountName": "[format('sa{0}', replace(parameters('partName'), '-', ''))]",
            "readRoleId": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
            "roleAssignmentName": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), parameters('principalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readRoleId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readRoleId'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "server-database-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DbName": {
            "value": "[parameters('databaseName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlAdministratorLogin": {
            "value": "[parameters('sqlAdminlogin')]"
          },
          "sqlAdministratorPassword": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('kvRgName')), 'Microsoft.KeyVault/vaults', parameters('keyVaulName'))]"
              },
              "secretName": "sqlPasswordAdmin"
            }
          },
          "webappIp": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'web-api-deployment'), '2022-09-01').outputs.webApiIp.value]"
          },
          "partName": {
            "value": "[parameters('partName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "5353542358263426648"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "DbName": {
              "type": "string",
              "metadata": {
                "description": "the name of the database"
              }
            },
            "sqlAdministratorLogin": {
              "type": "securestring",
              "metadata": {
                "description": "Specifies sql admin login"
              }
            },
            "sqlAdministratorPassword": {
              "type": "securestring",
              "minLength": 8,
              "metadata": {
                "description": "password of the admin for the sql server access"
              }
            },
            "webappIp": {
              "type": "array",
              "metadata": {
                "description": "the ip addresses of the web app that will connect to the server"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "sqlServerName": "[format('ssdb-{0}', parameters('partName'))]",
            "databaseName": "[format('sdb-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), variables('databaseName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 1073741824
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "endIpAddress": "0.0.0.0",
                "startIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "copy": {
                "name": "firewallRuleForWebApp",
                "count": "[length(parameters('webappIp'))]"
              },
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), format('AllowWebbApp-{0}', copyIndex()))]",
              "properties": {
                "startIpAddress": "[parameters('webappIp')[copyIndex()]]",
                "endIpAddress": "[parameters('webappIp')[copyIndex()]]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-05-01-preview",
              "name": "[variables('sqlServerName')]",
              "location": "[parameters('location')]",
              "properties": {
                "administratorLogin": "[parameters('sqlAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdministratorPassword')]",
                "version": "12.0"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'web-api-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "web-api-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "branch": {
            "value": "[parameters('branch')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "msiName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalName.value]"
          },
          "repoURL": {
            "value": "[parameters('repoUrl')]"
          },
          "skuCapacity": {
            "value": "[parameters('skuApiServiceCapacity')]"
          },
          "skuName": {
            "value": "[parameters('skuApiServiceName')]"
          },
          "partName": {
            "value": "[parameters('partName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "7546463557034922410"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies region for all resources"
              }
            },
            "skuName": {
              "type": "string",
              "metadata": {
                "description": "Specifies app plan SKU"
              }
            },
            "skuCapacity": {
              "type": "int",
              "metadata": {
                "description": "Specifies app plan capacity"
              }
            },
            "msiName": {
              "type": "string",
              "metadata": {
                "description": "the name of the managed identity to access keyvault"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            },
            "repoURL": {
              "type": "securestring",
              "metadata": {
                "description": "the url of the repositery where the code is"
              }
            },
            "branch": {
              "type": "string",
              "metadata": {
                "description": "the branch in the repo where the code is"
              }
            }
          },
          "variables": {
            "appServiceName": "[format('as-{0}', parameters('partName'))]",
            "webApiName": "[format('wa-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2020-12-01",
              "name": "[variables('appServiceName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "capacity": "[parameters('skuCapacity')]"
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('webApiName')]",
              "location": "[parameters('location')]",
              "tags": {
                "[format('hidden-related:{0}', resourceId('Microsoft.Web/serverfarms', variables('appServiceName')))]": "empty",
                "displayName": "Website"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServiceName'))]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('msiName')))]": {}
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/sourcecontrols",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('webApiName'), 'web')]",
              "properties": {
                "repoUrl": "[parameters('repoURL')]",
                "branch": "[parameters('branch')]",
                "isManualIntegration": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webApiName'))]"
              ]
            }
          ],
          "outputs": {
            "webApiId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('webApiName')), '2023-01-01').outboundIpAddresses]"
            },
            "webApiName": {
              "type": "string",
              "value": "[variables('webApiName')]"
            },
            "webApiIp": {
              "type": "array",
              "value": "[split(reference(resourceId('Microsoft.Web/sites', variables('webApiName')), '2023-01-01').outboundIpAddresses, ',')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appInsight-logspace-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "2863192701843867662"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "webApiName": "[format('wa-{0}', parameters('partName'))]",
            "workspaceName": "[format('wsa-{0}', parameters('partName'))]",
            "appinsightName": "[format('ai-{0}', parameters('partName'))]",
            "readRoleId": "43d0d8ad-25c7-4714-9337-8ba259a9fe05",
            "contributeRoleId": "92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 90,
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appinsightName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "logSpaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "logSpaceName": {
              "type": "string",
              "value": "[variables('workspaceName')]"
            },
            "readRoleId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readRoleId'))]"
            },
            "contributeRoleId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributeRoleId'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "set-configuration-for-api",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "apiConfigSet": {
            "value": "[parameters('apiConf')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "4608400785961012735"
            }
          },
          "parameters": {
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            },
            "apiConfigSet": {
              "type": "array",
              "metadata": {
                "description": "name of the client domain"
              }
            }
          },
          "variables": {
            "webApiName": "[format('wa-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "apiConfig",
                "count": "[length(parameters('apiConfigSet'))]"
              },
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('webApiName'), 'appsettings')]",
              "properties": {
                "[format('{0}', parameters('apiConfigSet')[copyIndex()].name)]": "[parameters('apiConfigSet')[copyIndex()].value]"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "role-assignment-insight",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "ContributeRoleAssignmentName": {
            "value": "[guid(reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.logSpaceId.value, reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value, reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.contributeRoleId.value)]"
          },
          "ContributeRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.contributeRoleId.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value]"
          },
          "ReadRoleAssignmentName": {
            "value": "[guid(reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.logSpaceId.value, reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value, reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.readRoleId.value)]"
          },
          "ReadRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment'), '2022-09-01').outputs.readRoleId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "17648445952437662510"
            }
          },
          "parameters": {
            "ContributeRoleAssignmentName": {
              "type": "string",
              "metadata": {
                "description": "role definition name"
              }
            },
            "ContributeRoleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "role definition id"
              }
            },
            "ReadRoleAssignmentName": {
              "type": "string",
              "metadata": {
                "description": "role definition name"
              }
            },
            "ReadRoleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "role definition id"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "principal id to will be given access to the resouurce"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "logSpaceName": "[format('wsa-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('logSpaceName'))]",
              "name": "[parameters('ContributeRoleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('ContributeRoleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', variables('logSpaceName'))]",
              "name": "[parameters('ReadRoleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('ReadRoleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appInsight-logspace-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managedIdDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "service-bus-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "partName": {
            "value": "[parameters('partName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "3299751717391945907"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "sbNameSpace": "[format('sbn-{0}', parameters('partName'))]",
            "sbTopics": "[format('{0}-topics', variables('sbNameSpace'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[variables('sbNameSpace')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/topics",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', variables('sbNameSpace'), variables('sbTopics'))]",
              "properties": {
                "requiresDuplicateDetection": true,
                "enablePartitioning": true,
                "enableBatchedOperations": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('sbNameSpace'))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusName": {
              "type": "string",
              "value": "[variables('sbNameSpace')]"
            },
            "serviceBusTopicName": {
              "type": "string",
              "value": "[variables('sbTopics')]"
            },
            "serviceBusId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', variables('sbNameSpace'))]"
            },
            "sbListenRoleDefinition": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0')]"
            },
            "sbSenderRoleDefinition": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '69a216fc-b8fb-44d8-bc22-1f3c2cd27a39')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "role-assignment-service-bus",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedIdDeploy'), '2022-09-01').outputs.manPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2022-09-01').outputs.sbSenderRoleDefinition.value]"
          },
          "serviceBusId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2022-09-01').outputs.serviceBusId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "7737679662362810404"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "serviceBusId": {
              "type": "string"
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv{0}', parameters('partName'))]",
            "roleAssignmentName": "[guid(parameters('serviceBusId'), parameters('principalId'), parameters('roleDefinitionId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedIdDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'service-bus-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "function-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "bindingName": {
            "value": "[parameters('bindingName')]"
          },
          "nameOfContainer": {
            "value": "[parameters('containerName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "8220908206443016483"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            },
            "nameOfContainer": {
              "type": "string",
              "metadata": {
                "description": "name of the container to be created"
              }
            },
            "bindingName": {
              "type": "string",
              "metadata": {
                "description": "name of the in value binded trigger"
              }
            }
          },
          "variables": {
            "functionAppName": "[format('fa-{0}', parameters('partName'))]",
            "appServicePlanName": "[format('as-{0}', parameters('partName'))]",
            "functionName": "[format('fn{0}', parameters('partName'))]",
            "functionRuntime": "dotnet",
            "storageAccountName": "[format('sa{0}', replace(parameters('partName'), '-', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-12-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage__accountname",
                      "value": "[variables('storageAccountName')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "[variables('functionRuntime')]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "EndpointToBlob",
                      "value": "[format('{0}/{1}', reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints.blob, parameters('nameOfContainer'))]"
                    },
                    {
                      "name": "Name",
                      "value": "[parameters('nameOfContainer')]"
                    }
                  ]
                },
                "httpsOnly": true
              }
            },
            {
              "type": "Microsoft.Web/sites/functions",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('functionAppName'), variables('functionName'))]",
              "properties": {
                "script_href": "https://github.com/Mouhsine-inetum/Food-delivery-productCreated-functionApp.git",
                "config": {
                  "disabled": false,
                  "bindings": [
                    {
                      "name": "[parameters('bindingName')]",
                      "type": "serviceBusTrigger",
                      "direction": "in",
                      "authLevel": "function",
                      "methods": [
                        "get"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionPrincipal": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2020-12-01', 'full').identity.principalId]"
            },
            "roleDefinitionForAppToStorage": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]"
            },
            "functionId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
            },
            "functionAppHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2020-12-01').defaultHostName]"
            },
            "functionName": {
              "type": "string",
              "value": "[variables('functionAppName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "role-assignment-function-app",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "partName": {
            "value": "[parameters('partName')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.functionPrincipal.value]"
          },
          "storageDataRoleAssignmentName": {
            "value": "[guid(reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.functionId.value, reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.functionPrincipal.value, reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.roleDefinitionForAppToStorage.value)]"
          },
          "storageDataRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.roleDefinitionForAppToStorage.value]"
          },
          "topicsListenerRoleAssignmentName": {
            "value": "[guid(reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.functionId.value, reference(resourceId('Microsoft.Resources/deployments', 'function-app-deployment'), '2022-09-01').outputs.functionPrincipal.value, reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2022-09-01').outputs.sbListenRoleDefinition.value)]"
          },
          "topicsListenerRoleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2022-09-01').outputs.sbListenRoleDefinition.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.54.24096",
              "templateHash": "11421345708842460289"
            }
          },
          "parameters": {
            "storageDataRoleAssignmentName": {
              "type": "string",
              "metadata": {
                "description": "role definition name"
              }
            },
            "storageDataRoleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "role definition id"
              }
            },
            "topicsListenerRoleAssignmentName": {
              "type": "string",
              "metadata": {
                "description": "role definition name"
              }
            },
            "topicsListenerRoleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "role definition id"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "principal id to will be given access to the resouurce"
              }
            },
            "partName": {
              "type": "string",
              "metadata": {
                "description": "component name used for resource name"
              }
            }
          },
          "variables": {
            "storageServiceName": "[format('sa{0}', replace(parameters('partName'), '-', ''))]",
            "serviceBusName": "[format('sbn-{0}', parameters('partName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageServiceName'))]",
              "name": "[parameters('storageDataRoleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('storageDataRoleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', variables('serviceBusName'))]",
              "name": "[parameters('topicsListenerRoleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('topicsListenerRoleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'function-app-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'service-bus-deployment')]"
      ]
    }
  ]
}